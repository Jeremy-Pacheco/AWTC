<%- include('header', { shopName: shopName, currentUser: currentUser, currentSection: (typeof currentSection !== 'undefined' ? currentSection : 'overview') }) %>

<style>
    .section-card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    @media (max-width: 768px) {
      .section-card {
        padding: 16px;
        margin-bottom: 16px;
      }
    }  .section-title {
    font-size: 24px;
    font-weight: 700;
    color: #1a202c;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-subtitle {
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
    margin-top: 20px;
    margin-bottom: 12px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, #fff 0%, #F0BB00 100%);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(240, 187, 0, 0.2);
  }

  .stat-label {
    font-size: 14px;
    color: #4a5568;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #1a202c;
  }

  .item-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .item-list-item {
    background: #f7fafc;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
  }

  .item-list-item:hover {
    background: #fff;
    border-color: #cbd5e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .item-title {
    font-weight: 600;
    color: #1a202c;
    font-size: 16px;
  }

  .item-meta {
    color: #718096;
    font-size: 14px;
    margin-top: 4px;
  }

  .item-description {
    color: #4a5568;
    font-size: 14px;
    margin-top: 8px;
    line-height: 1.5;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #718096;
  }

  .empty-state i {
    font-size: 48px;
    color: #cbd5e0;
    margin-bottom: 16px;
  }
</style>

  <% if (currentSection === 'overview') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-chart-line" style="color: #F0BB00;"></i>
      Overview
    </h2>
    <p style="color: #4a5568; margin-bottom: 30px; font-size: 15px;">General dashboard statistics</p>
    
    <div class="overview-stats">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-project-diagram"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= projectsNumber || 0 %></div>
          <div class="stat-label">Total Projects</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-tags"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= categories ? categories.length : 0 %></div>
          <div class="stat-label">Categories</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= users ? users.length : 0 %></div>
          <div class="stat-label">Total Users</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-star"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= reviews ? reviews.length : 0 %></div>
          <div class="stat-label">Reviews</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= contacts ? contacts.length : 0 %></div>
          <div class="stat-label">Incidents</div>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    .overview-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(240, 187, 0, 0.2);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #1a202c;
      line-height: 1;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 1024px) {
      .overview-stats {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-icon {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
      
      .stat-number {
        font-size: 24px;
      }
      
      .stat-label {
        font-size: 12px;
      }
    }
    
    @media (max-width: 768px) {
      .overview-stats {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      
      .stat-card {
        padding: 12px;
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .stat-number {
        font-size: 22px;
      }
    }
  </style>
  <% } %>

  <% if (currentSection === 'projects') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-project-diagram" style="color: #F0BB00;"></i>
      Projects
    </h2>
    <p style="color: #4a5568; margin-bottom: 20px;">Total projects: <strong><%= projectsNumber %></strong> | Latest: <%= latestProjects ? latestProjects.length : 0 %></p>
    
    <h3 class="section-subtitle">Latest Projects</h3>
    <% if (latestProjects && latestProjects.length) { %>
      <ul class="item-list">
        <% latestProjects.forEach(function(p){ %>
          <li class="item-list-item" id="proj-<%= p.id %>">
            <div class="item-title"><%= p.name %></div>
            <% if (p.status) { %>
              <div class="item-meta">Status: <%= p.status %></div>
            <% } %>
            <% if (p.description) { %>
              <div class="item-description"><%= p.description %></div>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>No recent projects to display.</p>
      </div>
    <% } %>
  </div>
  <% } %>

  <% if (currentSection === 'users') { %>
  <!-- D3.js Library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <style>
    .users-dashboard {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
      margin-bottom: 0;
    }

    @media (max-width: 1400px) {
      .users-dashboard {
        grid-template-columns: 300px 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 1024px) {
      .users-dashboard {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .users-dashboard {
        gap: 16px;
      }
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .user-list-container {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }
    
    @media (max-width: 768px) {
      .user-list-container {
        padding: 16px;
      }
    }

    .user-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #F0BB00;
    }

    .user-list-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-count-badge {
      background: #F0BB00;
      color: #1a202c;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .user-item {
      padding: 16px;
      margin-bottom: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 3px solid #cbd5e0;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .user-item:hover {
      background: #fff;
      border-left-color: #F0BB00;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transform: translateX(4px);
    }

    .user-item-name {
      font-weight: 600;
      color: #1a202c;
      font-size: 15px;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .user-item-email {
      font-size: 13px;
      color: #718096;
      margin-bottom: 6px;
      word-break: break-all;
    }

    .user-item-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin { background: #feb2b2; color: #742a2a; }
    .role-coordinator { background: #bee3f8; color: #2c5282; }
    .role-volunteer { background: #c6f6d5; color: #22543d; }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .pagination-btn {
      background: #fff;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #4a5568;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #F0BB00;
      border-color: #F0BB00;
      color: #1a202c;
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pagination-info {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
    }

    .chart-container {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    @media (max-width: 768px) {
      .chart-container {
        padding: 16px;
      }
    }

    .chart-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #F0BB00;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .chart-subtitle {
      font-size: 13px;
      color: #718096;
    }

    #registrationsChart, #roleDistributionChart, #projectsPerUserChart, #userActivityChart {
      width: 100%;
      height: 280px;
    }

    @media (max-width: 768px) {
      #registrationsChart, #roleDistributionChart, #projectsPerUserChart, #userActivityChart {
        height: 250px;
      }
    }

    @media (max-width: 480px) {
      #registrationsChart, #roleDistributionChart, #projectsPerUserChart, #userActivityChart {
        height: 220px;
      }
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
  </style>

  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-users" style="color: #F0BB00;"></i>
      Users Dashboard
    </h2>
  </div>

  <div class="users-dashboard">
    <!-- User List Component -->
    <div class="user-list-container">
      <div class="user-list-header">
        <div class="user-list-title">
          <i class="fas fa-user-friends"></i>
          User List
        </div>
        <span class="user-count-badge"><%= usersNumber %> Total</span>
      </div>
      
      <div id="userListContent"></div>
      
      <div class="pagination">
        <button class="pagination-btn" id="prevPage" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
        <button class="pagination-btn" id="nextPage" disabled>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Registration Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-line" style="color: #F0BB00;"></i>
            Registrations - 7 Days
          </div>
          <div class="chart-subtitle">Daily trends</div>
        </div>
        <div id="registrationsChart"></div>
      </div>

      <!-- Role Distribution Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-pie" style="color: #F0BB00;"></i>
            Role Distribution
          </div>
          <div class="chart-subtitle">By user role</div>
        </div>
        <div id="roleDistributionChart"></div>
      </div>

      <!-- Projects Per User Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-user-circle" style="color: #F0BB00;"></i>
            <span id="selectedUserTitle">User Projects</span>
          </div>
          <div class="chart-subtitle" id="selectedUserSubtitle">Click on any user</div>
        </div>
        <div id="projectsPerUserChart"></div>
      </div>

      <!-- User Activity Over Time Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-area" style="color: #F0BB00;"></i>
            User Activity Trend
          </div>
          <div class="chart-subtitle">Active users in projects - Last 7 days</div>
        </div>
        <div id="userActivityChart"></div>
      </div>
    </div>
  </div>

  <script>
    // User data from server
    const allUsers = <%- JSON.stringify(users || []) %>;
    const allProjects = <%- JSON.stringify(projects || []) %>;
    const userProjectsData = <%- JSON.stringify(typeof projectsPerUser !== 'undefined' ? projectsPerUser : []) %>;
    const allUserProjects = <%- JSON.stringify(typeof allUserProjects !== 'undefined' ? allUserProjects : []) %>;
    const USERS_PER_PAGE = 6;
    let currentPage = 1;
    let selectedUserId = null;

    // Pagination logic
    function renderUserList(page) {
      const start = (page - 1) * USERS_PER_PAGE;
      const end = start + USERS_PER_PAGE;
      const pageUsers = allUsers.slice(start, end);
      const totalPages = Math.ceil(allUsers.length / USERS_PER_PAGE);

      const container = document.getElementById('userListContent');
      container.innerHTML = pageUsers.map(user => `
        <div class="user-item" data-user-id="${user.id}" onclick="selectUser(${user.id})" style="cursor: pointer;">
          <div class="user-item-name">${user.name || 'No name'}</div>
          <div class="user-item-email">${user.email || 'no-email'}</div>
          <span class="user-item-role role-${user.role || 'volunteer'}">${user.role || 'volunteer'}</span>
        </div>
      `).join('');

      document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
      document.getElementById('prevPage').disabled = page === 1;
      document.getElementById('nextPage').disabled = page === totalPages;
      
      // Highlight selected user if on current page
      if (selectedUserId) {
        const selectedElement = container.querySelector(`[data-user-id="${selectedUserId}"]`);
        if (selectedElement) {
          selectedElement.style.borderLeft = '3px solid #F0BB00';
          selectedElement.style.background = '#fffbeb';
        }
      }
    }

    // Select user and render their projects
    function selectUser(userId) {
      selectedUserId = userId;
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      
      // Update title
      document.getElementById('selectedUserTitle').textContent = user.name || user.email;
      document.getElementById('selectedUserSubtitle').textContent = `Projects enrolled by ${user.name || user.email}`;
      
      // Highlight selected user
      document.querySelectorAll('.user-item').forEach(item => {
        item.style.borderLeft = '3px solid #cbd5e0';
        item.style.background = '#f7fafc';
      });
      const selectedElement = document.querySelector(`[data-user-id="${userId}"]`);
      if (selectedElement) {
        selectedElement.style.borderLeft = '3px solid #F0BB00';
        selectedElement.style.background = '#fffbeb';
      }
      
      renderUserProjectsChart(userId);
    }

    async function renderUserProjectsChart(userId) {
      // Clear previous chart
      d3.select('#projectsPerUserChart').selectAll('*').remove();
      
      // Count projects directly from allUserProjects (using parseInt for type-safe comparison)
      const projectCount = allUserProjects.filter(up => parseInt(up.userId) === parseInt(userId)).length;
      
      if (projectCount === 0) {
        document.getElementById('projectsPerUserChart').innerHTML = 
          '<div style="text-align:center;padding:60px;color:#718096;"><i class="fas fa-folder-open" style="font-size:48px;color:#cbd5e0;margin-bottom:16px;display:block;"></i><p>This user has not enrolled in any projects yet</p></div>';
        return;
      }
      
      // Create simple metric display
      const container = document.getElementById('projectsPerUserChart');
      const width = container.offsetWidth;
      const height = 280;
      const margin = 20; // Add margin from edges
      
      const svg = d3.select('#projectsPerUserChart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
      
      // Create circular progress indicator
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = 70;
      
      // Background circle
      svg.append('circle')
        .attr('cx', centerX)
        .attr('cy', centerY)
        .attr('r', radius)
        .attr('fill', 'none')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', 12);
      
      // Progress circle
      const circumference = 2 * Math.PI * radius;
      const maxProjects = Math.max(...userProjectsData.map(u => u.projectCount), 10);
      const progress = (projectCount / maxProjects) * circumference;
      
      svg.append('circle')
        .attr('cx', centerX)
        .attr('cy', centerY)
        .attr('r', radius)
        .attr('fill', 'none')
        .attr('stroke', '#F0BB00')
        .attr('stroke-width', 12)
        .attr('stroke-linecap', 'round')
        .attr('stroke-dasharray', `${circumference} ${circumference}`)
        .attr('stroke-dashoffset', circumference)
        .attr('transform', `rotate(-90 ${centerX} ${centerY})`)
        .transition()
        .duration(1000)
        .attr('stroke-dashoffset', circumference - progress);
      
      // Center text - Number
      svg.append('text')
        .attr('x', centerX)
        .attr('y', centerY - 10)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('font-size', '48px')
        .style('font-weight', '700')
        .style('fill', '#1a202c')
        .text('0')
        .transition()
        .duration(1000)
        .tween('text', function() {
          const interpolator = d3.interpolateNumber(0, projectCount);
          return function(t) {
            d3.select(this).text(Math.round(interpolator(t)));
          };
        });
      
      // Center text - Label
      svg.append('text')
        .attr('x', centerX)
        .attr('y', centerY + 25)
        .attr('text-anchor', 'middle')
        .style('font-size', '14px')
        .style('fill', '#718096')
        .text('Projects Enrolled');
      
      // Add comparison text
      const avgProjects = userProjectsData.length > 0 
        ? (userProjectsData.reduce((sum, u) => sum + u.projectCount, 0) / userProjectsData.length).toFixed(1)
        : 0;
      
      svg.append('text')
        .attr('x', centerX)
        .attr('y', height - 40)
        .attr('text-anchor', 'middle')
        .style('font-size', '13px')
        .style('fill', '#4a5568')
        .text(`Platform average: ${avgProjects} projects per user`);
      
      // Status badge
      const status = projectCount > avgProjects ? 'Above Average' : projectCount == avgProjects ? 'Average' : 'Below Average';
      const statusColor = projectCount > avgProjects ? '#48bb78' : projectCount == avgProjects ? '#F0BB00' : '#718096';
      
      svg.append('rect')
        .attr('x', centerX - 60)
        .attr('y', height - 20)
        .attr('width', 120)
        .attr('height', 24)
        .attr('rx', 12)
        .attr('fill', statusColor)
        .attr('opacity', 0.2);
      
      svg.append('text')
        .attr('x', centerX)
        .attr('y', height - 8)
        .attr('text-anchor', 'middle')
        .style('font-size', '11px')
        .style('font-weight', '600')
        .style('fill', statusColor)
        .text(status);
    }

    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderUserList(currentPage);
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(allUsers.length / USERS_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        renderUserList(currentPage);
      }
    });

    // Initial render
    renderUserList(1);

    // D3.js Chart 1: User Registrations Last 7 Days
    function renderRegistrationsChart() {
      const last7Days = [];
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        const count = allUsers.filter(u => {
          if (!u.createdAt) return false;
          const userDate = new Date(u.createdAt).toISOString().split('T')[0];
          return userDate === dateStr;
        }).length;
        
        last7Days.push({
          date: dateStr,
          count: count,
          label: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
        });
      }

      const margin = { top: 20, right: 30, bottom: 60, left: 50 };
      const container = document.getElementById('registrationsChart');
      const width = container.offsetWidth - margin.left - margin.right;
      const height = 300 - margin.top - margin.bottom;

      const svg = d3.select('#registrationsChart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(last7Days.map(d => d.label))
        .range([0, width])
        .padding(0.3);

      const y = d3.scaleLinear()
        .domain([0, d3.max(last7Days, d => d.count) + 2])
        .range([height, 0]);

      // Grid lines
      svg.append('g')
        .attr('class', 'grid')
        .attr('opacity', 0.1)
        .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

      // Bars
      svg.selectAll('.bar')
        .data(last7Days)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.label))
        .attr('width', x.bandwidth())
        .attr('y', height)
        .attr('height', 0)
        .attr('fill', '#F0BB00')
        .attr('rx', 4)
        .transition()
        .duration(800)
        .attr('y', d => y(d.count))
        .attr('height', d => height - y(d.count));

      // Add value labels on bars
      svg.selectAll('.label')
        .data(last7Days)
        .enter()
        .append('text')
        .attr('class', 'label')
        .attr('x', d => x(d.label) + x.bandwidth() / 2)
        .attr('y', d => y(d.count) - 5)
        .attr('text-anchor', 'middle')
        .attr('fill', '#1a202c')
        .attr('font-size', '12px')
        .attr('font-weight', '600')
        .text(d => d.count);

      // X axis
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'rotate(-45)')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em');

      // Y axis
      svg.append('g')
        .call(d3.axisLeft(y).ticks(5));
    }

    // D3.js Chart 2: Role Distribution (Donut Chart)
    function renderRoleDistributionChart() {
      const roleCounts = {};
      allUsers.forEach(user => {
        const role = user.role || 'volunteer';
        roleCounts[role] = (roleCounts[role] || 0) + 1;
      });

      const data = Object.entries(roleCounts).map(([role, count]) => ({
        role: role,
        count: count
      }));

      const width = document.getElementById('roleDistributionChart').offsetWidth;
      const isMobile = width < 480;
      const isTablet = width >= 480 && width < 768;
      const height = isMobile ? 250 : 300;
      const svgHeight = isMobile ? 180 : height;
      const radius = isMobile ? Math.min(width, svgHeight) / 2 - 20 : Math.min(width, height) / 2 - 40;

      const svg = d3.select('#roleDistributionChart')
        .append('svg')
        .attr('width', width)
        .attr('height', svgHeight)
        .append('g')
        .attr('transform', `translate(${width / 2},${svgHeight / 2})`);

      const color = d3.scaleOrdinal()
        .domain(data.map(d => d.role))
        .range(['#feb2b2', '#bee3f8', '#c6f6d5', '#fbd38d']);

      const pie = d3.pie()
        .value(d => d.count)
        .sort(null);

      const arc = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius);

      const arcHover = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius * 1.05);

      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip');

      const arcs = svg.selectAll('.arc')
        .data(pie(data))
        .enter()
        .append('g')
        .attr('class', 'arc');

      arcs.append('path')
        .attr('d', arc)
        .attr('fill', d => color(d.data.role))
        .attr('stroke', '#fff')
        .attr('stroke-width', 3)
        .on('mouseover', function(event, d) {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('d', arcHover);
          
          tooltip
            .style('opacity', 1)
            .html(`<strong>${d.data.role}</strong><br>${d.data.count} users (${((d.data.count / allUsers.length) * 100).toFixed(1)}%)`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('d', arc);
          
          tooltip.style('opacity', 0);
        })
        .transition()
        .duration(800)
        .attrTween('d', function(d) {
          const interpolate = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
          return function(t) {
            return arc(interpolate(t));
          };
        });

      // Center text
      svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '-0.5em')
        .style('font-size', '32px')
        .style('font-weight', '700')
        .style('fill', '#1a202c')
        .text(allUsers.length);

      svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '1.2em')
        .style('font-size', '14px')
        .style('fill', '#718096')
        .text('Total Users');

      // Legend - Responsive
      if (isMobile) {
        // En móvil: leyenda horizontal debajo del donut
        const legendContainer = d3.select('#roleDistributionChart')
          .append('div')
          .style('display', 'flex')
          .style('flex-wrap', 'wrap')
          .style('justify-content', 'center')
          .style('gap', '6px')
          .style('margin-top', '8px')
          .style('padding', '0 8px');

        data.forEach(d => {
          const item = legendContainer.append('div')
            .style('display', 'flex')
            .style('align-items', 'center')
            .style('gap', '4px');

          item.append('div')
            .style('width', '12px')
            .style('height', '12px')
            .style('border-radius', '2px')
            .style('background', color(d.role))
            .style('flex-shrink', '0');

          item.append('span')
            .style('font-size', '11px')
            .style('color', '#4a5568')
            .text(`${d.role} (${d.count})`);
        });
      } else if (isTablet) {
        // En tablet: leyenda más compacta a la derecha
        const legend = svg.selectAll('.legend')
          .data(data)
          .enter()
          .append('g')
          .attr('class', 'legend')
          .attr('transform', (d, i) => `translate(${radius + 15},${-30 + i * 22})`);

        legend.append('rect')
          .attr('width', 14)
          .attr('height', 14)
          .attr('rx', 2)
          .attr('fill', d => color(d.role));

        legend.append('text')
          .attr('x', 18)
          .attr('y', 7)
          .attr('dy', '.35em')
          .style('font-size', '11px')
          .style('fill', '#4a5568')
          .text(d => `${d.role} (${d.count})`);
      } else {
        // Desktop: leyenda normal
        const legend = svg.selectAll('.legend')
          .data(data)
          .enter()
          .append('g')
          .attr('class', 'legend')
          .attr('transform', (d, i) => `translate(${radius + 20},${-40 + i * 25})`);

        legend.append('rect')
          .attr('width', 18)
          .attr('height', 18)
          .attr('rx', 3)
          .attr('fill', d => color(d.role));

        legend.append('text')
          .attr('x', 24)
          .attr('y', 9)
          .attr('dy', '.35em')
          .style('font-size', '13px')
          .style('fill', '#4a5568')
          .text(d => `${d.role} (${d.count})`);
      }
    }

    // D3.js Chart 4: User Activity Trend (Area Chart)
    function renderUserActivityChart() {
      // Generate daily data for last 7 days
      const days = [];
      const now = new Date();
      
      // Create array for last 7 days
      for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0); // Start of day
        
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        
        // Count enrollments created on this specific day
        const count = allUserProjects.filter(up => {
          if (!up.createdAt) return false;
          const createdDate = new Date(up.createdAt);
          createdDate.setHours(0, 0, 0, 0); // Normalize to start of day
          return createdDate.getTime() === date.getTime();
        }).length;
        
        days.push({
          month: dayName,
          count: count,
          date: date
        });
      }
      
      // Calculate accumulated counts (show growth trend)
      let accumulated = 0;
      days.forEach(d => {
        accumulated += d.count;
        d.accumulated = accumulated;
      });

      const container = document.getElementById('userActivityChart');
      const width = container.offsetWidth;
      const height = 280;
      const margin = { top: 20, right: 30, bottom: 60, left: 50 };

      const svg = d3.select('#userActivityChart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      const x = d3.scalePoint()
        .domain(days.map(d => d.month))
        .range([margin.left, width - margin.right])
        .padding(0.5);

      const y = d3.scaleLinear()
        .domain([0, d3.max(days, d => d.accumulated) * 1.1])
        .nice()
        .range([height - margin.bottom, margin.top]);

      // Area generator
      const area = d3.area()
        .x(d => x(d.month))
        .y0(height - margin.bottom)
        .y1(d => y(d.accumulated))
        .curve(d3.curveMonotoneX);

      // Line generator
      const line = d3.line()
        .x(d => x(d.month))
        .y(d => y(d.accumulated))
        .curve(d3.curveMonotoneX);

      // Gradient for area fill
      const gradient = svg.append('defs')
        .append('linearGradient')
        .attr('id', 'areaGradient')
        .attr('x1', '0%')
        .attr('y1', '0%')
        .attr('x2', '0%')
        .attr('y2', '100%');

      gradient.append('stop')
        .attr('offset', '0%')
        .attr('stop-color', '#F0BB00')
        .attr('stop-opacity', 0.6);

      gradient.append('stop')
        .attr('offset', '100%')
        .attr('stop-color', '#F0BB00')
        .attr('stop-opacity', 0.1);

      // Draw area
      svg.append('path')
        .datum(days)
        .attr('fill', 'url(#areaGradient)')
        .attr('d', area)
        .style('opacity', 0)
        .transition()
        .duration(1000)
        .style('opacity', 1);

      // Draw line
      svg.append('path')
        .datum(days)
        .attr('fill', 'none')
        .attr('stroke', '#F0BB00')
        .attr('stroke-width', 3)
        .attr('d', line)
        .attr('stroke-dasharray', function() {
          const length = this.getTotalLength();
          return `${length} ${length}`;
        })
        .attr('stroke-dashoffset', function() {
          return this.getTotalLength();
        })
        .transition()
        .duration(1500)
        .attr('stroke-dashoffset', 0);

      // Add points
      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip');

      svg.selectAll('.dot')
        .data(days)
        .enter()
        .append('circle')
        .attr('class', 'dot')
        .attr('cx', d => x(d.month))
        .attr('cy', d => y(d.accumulated))
        .attr('r', 0)
        .attr('fill', '#F0BB00')
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .on('mouseover', function(event, d) {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('r', 8);
          
          tooltip
            .style('opacity', 1)
            .html(`<strong>${d.month}</strong><br>Active Enrollments: ${d.accumulated}<br>New: +${d.count}`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('r', 5);
          
          tooltip.style('opacity', 0);
        })
        .transition()
        .delay((d, i) => i * 100 + 1000)
        .duration(400)
        .attr('r', 5);

      // X axis
      svg.append('g')
        .attr('transform', `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', 'rotate(-45)');

      // Y axis
      svg.append('g')
        .attr('transform', `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(5));

      // Y axis label
      svg.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', margin.left - 35)
        .attr('x', -(height / 2))
        .attr('text-anchor', 'middle')
        .style('font-size', '12px')
        .style('fill', '#718096')
        .text('Total Active Users');
    }

    // Render charts on load
    if (typeof d3 !== 'undefined') {
      renderRegistrationsChart();
      renderRoleDistributionChart();
      renderUserActivityChart();
      // User projects chart renders on user click
    }
  </script>
  <% } %>

  <% if (currentSection === 'categories') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-tags" style="color: #F0BB00;"></i>
      Categories
    </h2>
    <p style="color: #4a5568; margin-bottom: 20px; font-size: 16px; font-weight: 600;">
      Total categories: <span style="color: #F0BB00; font-size: 18px;"><%= categories ? categories.length : 0 %></span>
    </p>
    
    <% if (categories && categories.length) { %>
      <ul class="item-list">
        <% categories.forEach(function(c){ %>
          <li class="item-list-item">
            <div class="item-title"><%= c.name %></div>
            <% if (c.description) { %>
              <div class="item-description"><%= c.description %></div>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-tags"></i>
        <p>No categories available</p>
      </div>
    <% } %>
  </div>
  <% } %>

  <% if (currentSection === 'reviews') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-star" style="color: #F0BB00;"></i>
      Reviews
    </h2>
    <p style="color: #4a5568; margin-bottom: 20px;">Total reviews: <%= reviews ? reviews.length : 0 %></p>
    
    <% if (reviews && reviews.length) { %>
      <ul class="item-list">
        <% reviews.forEach(function(r){ %>
          <li class="item-list-item">
            <div class="item-description"><%= r.content || ('Review #' + r.id) %></div>
            <% if (r.date) { %>
              <div class="item-meta"><%= new Date(r.date).toLocaleDateString() %></div>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-star"></i>
        <p>No reviews available</p>
      </div>
    <% } %>
  </div>
  <% } %>

  <% if (currentSection === 'contacts') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-exclamation-triangle" style="color: #F0BB00;"></i>
      Incidents
    </h2>
    <p style="color: #4a5568; margin-bottom: 20px;">Total incidents: <%= contacts ? contacts.length : 0 %></p>
    
    <% if (typeof contacts !== 'undefined' && contacts && contacts.length) { %>
      <ul class="item-list">
        <% contacts.forEach(function(c){ %>
          <li class="item-list-item">
            <div class="item-title"><%= c.name %></div>
            <div class="item-meta"><%= c.email %><% if (c.subject) { %> — <%= c.subject %><% } %></div>
            <div class="item-description"><%= c.message %></div>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>No contact messages yet</p>
      </div>
    <% } %>
  </div>
  <% } %>

</body>
</html>

      </div>
    </div>
  </body>
</html>