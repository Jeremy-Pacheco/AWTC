<%- include('header', { shopName: shopName, currentUser: currentUser, currentSection: (typeof currentSection !== 'undefined' ? currentSection : 'overview') }) %>

<style>
    .section-card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    @media (max-width: 768px) {
      .section-card {
        padding: 16px;
        margin-bottom: 16px;
      }
    }  .section-title {
    font-size: 24px;
    font-weight: 700;
    color: #1a202c;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-subtitle {
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
    margin-top: 20px;
    margin-bottom: 12px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, #fff 0%, #F0BB00 100%);
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(240, 187, 0, 0.2);
  }

  .stat-label {
    font-size: 14px;
    color: #4a5568;
    font-weight: 500;
    margin-bottom: 8px;
  }

  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #1a202c;
  }

  .item-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .item-list-item {
    background: #f7fafc;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
  }

  .item-list-item:hover {
    background: #fff;
    border-color: #cbd5e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .item-title {
    font-weight: 600;
    color: #1a202c;
    font-size: 16px;
  }

  .item-meta {
    color: #718096;
    font-size: 14px;
    margin-top: 4px;
  }

  .item-description {
    color: #4a5568;
    font-size: 14px;
    margin-top: 8px;
    line-height: 1.5;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #718096;
  }

  .empty-state i {
    font-size: 48px;
    color: #cbd5e0;
    margin-bottom: 16px;
  }
</style>

  <% if (currentSection === 'overview') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-chart-line" style="color: #F0BB00;"></i>
      Overview
    </h2>
    <p style="color: #4a5568; margin-bottom: 30px; font-size: 15px;">General dashboard statistics</p>
    
    <div class="overview-stats">
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-project-diagram"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= projectsNumber || 0 %></div>
          <div class="stat-label">Total Projects</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-tags"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= categories ? categories.length : 0 %></div>
          <div class="stat-label">Categories</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= users ? users.length : 0 %></div>
          <div class="stat-label">Total Users</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-star"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= reviews ? reviews.length : 0 %></div>
          <div class="stat-label">Reviews</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= contacts ? contacts.length : 0 %></div>
          <div class="stat-label">Incidents</div>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    .overview-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(240, 187, 0, 0.2);
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #1a202c;
      line-height: 1;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 1024px) {
      .overview-stats {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-icon {
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
      
      .stat-number {
        font-size: 24px;
      }
      
      .stat-label {
        font-size: 12px;
      }
    }
    
    @media (max-width: 768px) {
      .overview-stats {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      
      .stat-card {
        padding: 12px;
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .stat-number {
        font-size: 22px;
      }
    }
  </style>
  <% } %>

  <% if (currentSection === 'projects') { %>
    <%- include('projects-dashboard', { projects: projects, categories: categories, allUserProjects: allUserProjects }) %>
  <% } %>

  <% if (currentSection === 'users') { %>
  <!-- D3.js Library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <style>
    .users-dashboard {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
      margin-bottom: 0;
    }

    @media (max-width: 1400px) {
      .users-dashboard {
        grid-template-columns: 300px 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 1024px) {
      .users-dashboard {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .users-dashboard {
        gap: 16px;
      }
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .user-list-container {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }
    
    @media (max-width: 768px) {
      .user-list-container {
        padding: 16px;
      }
    }

    .user-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #F0BB00;
    }

    .user-list-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-count-badge {
      background: #F0BB00;
      color: #1a202c;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .user-item {
      padding: 16px;
      margin-bottom: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border-left: 3px solid #cbd5e0;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .user-item:hover {
      background: #fff;
      border-left-color: #F0BB00;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transform: translateX(4px);
    }

    .user-item-name {
      font-weight: 600;
      color: #1a202c;
      font-size: 15px;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .user-item-email {
      font-size: 13px;
      color: #718096;
      margin-bottom: 6px;
      word-break: break-all;
    }

    .user-item-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-admin { background: #feb2b2; color: #742a2a; }
    .role-coordinator { background: #bee3f8; color: #2c5282; }
    .role-volunteer { background: #c6f6d5; color: #22543d; }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .pagination-btn {
      background: #fff;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #4a5568;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #F0BB00;
      border-color: #F0BB00;
      color: #1a202c;
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pagination-info {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
    }

    .chart-container {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e2e8f0;
    }

    @media (max-width: 768px) {
      .chart-container {
        padding: 16px;
      }
    }

    .chart-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #F0BB00;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .chart-subtitle {
      font-size: 13px;
      color: #718096;
    }

    #registrationsChart, #roleDistributionChart, #projectsPerUserChart, #userActivityChart {
      width: 100%;
      height: 280px;
    }

    @media (max-width: 768px) {
      #registrationsChart, #roleDistributionChart, #projectsPerUserChart, #userActivityChart {
        height: 250px;
      }
    }

    @media (max-width: 480px) {
      #registrationsChart, #roleDistributionChart, #projectsPerUserChart, #userActivityChart {
        height: 220px;
      }
    }

    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
  </style>

  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-users" style="color: #F0BB00;"></i>
      Users Dashboard
    </h2>
  </div>

  <div class="users-dashboard">
    <!-- User List Component -->
    <div class="user-list-container">
      <div class="user-list-header">
        <div class="user-list-title">
          <i class="fas fa-user-friends"></i>
          User List
        </div>
        <span class="user-count-badge"><%= usersNumber %> Total</span>
      </div>
      
      <div id="userListContent"></div>
      
      <div class="pagination">
        <button class="pagination-btn" id="prevPage" disabled>
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
        <button class="pagination-btn" id="nextPage" disabled>
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Registration Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-line" style="color: #F0BB00;"></i>
            Registrations - 7 Days
          </div>
          <div class="chart-subtitle">Daily trends</div>
        </div>
        <div id="registrationsChart"></div>
      </div>

      <!-- Role Distribution Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-pie" style="color: #F0BB00;"></i>
            Role Distribution
          </div>
          <div class="chart-subtitle">By user role</div>
        </div>
        <div id="roleDistributionChart"></div>
      </div>

      <!-- Projects Per User Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-user-circle" style="color: #F0BB00;"></i>
            <span id="selectedUserTitle">User Projects</span>
          </div>
          <div class="chart-subtitle" id="selectedUserSubtitle">Click on any user</div>
        </div>
        <div id="projectsPerUserChart"></div>
      </div>

      <!-- User Activity Over Time Chart Component -->
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">
            <i class="fas fa-chart-area" style="color: #F0BB00;"></i>
            User Activity Trend
          </div>
          <div class="chart-subtitle">Active users in projects - Last 7 days</div>
        </div>
        <div id="userActivityChart"></div>
      </div>
    </div>
  </div>

  <script>
    // User data from server
    const allUsers = <%- JSON.stringify(users || []) %>;
    const allProjects = <%- JSON.stringify(projects || []) %>;
    const userProjectsData = <%- JSON.stringify(typeof projectsPerUser !== 'undefined' ? projectsPerUser : []) %>;
    const allUserProjects = <%- JSON.stringify(typeof allUserProjects !== 'undefined' ? allUserProjects : []) %>;
    const USERS_PER_PAGE = 6;
    let currentPage = 1;
    let selectedUserId = null;

    // Pagination logic
    function renderUserList(page) {
      const start = (page - 1) * USERS_PER_PAGE;
      const end = start + USERS_PER_PAGE;
      const pageUsers = allUsers.slice(start, end);
      const totalPages = Math.ceil(allUsers.length / USERS_PER_PAGE);

      const container = document.getElementById('userListContent');
      container.innerHTML = pageUsers.map(user => `
        <div class="user-item" data-user-id="${user.id}" onclick="selectUser(${user.id})" style="cursor: pointer;">
          <div class="user-item-name">${user.name || 'No name'}</div>
          <div class="user-item-email">${user.email || 'no-email'}</div>
          <span class="user-item-role role-${user.role || 'volunteer'}">${user.role || 'volunteer'}</span>
        </div>
      `).join('');

      document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
      document.getElementById('prevPage').disabled = page === 1;
      document.getElementById('nextPage').disabled = page === totalPages;
      
      // Highlight selected user if on current page
      if (selectedUserId) {
        const selectedElement = container.querySelector(`[data-user-id="${selectedUserId}"]`);
        if (selectedElement) {
          selectedElement.style.borderLeft = '3px solid #F0BB00';
          selectedElement.style.background = '#fffbeb';
        }
      }
    }

    // Select user and render their projects
    function selectUser(userId) {
      selectedUserId = userId;
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      
      // Update title
      document.getElementById('selectedUserTitle').textContent = user.name || user.email;
      document.getElementById('selectedUserSubtitle').textContent = `Projects enrolled by ${user.name || user.email}`;
      
      // Highlight selected user
      document.querySelectorAll('.user-item').forEach(item => {
        item.style.borderLeft = '3px solid #cbd5e0';
        item.style.background = '#f7fafc';
      });
      const selectedElement = document.querySelector(`[data-user-id="${userId}"]`);
      if (selectedElement) {
        selectedElement.style.borderLeft = '3px solid #F0BB00';
        selectedElement.style.background = '#fffbeb';
      }
      
      renderUserProjectsChart(userId);
    }

    async function renderUserProjectsChart(userId) {
      // Clear previous chart
      d3.select('#projectsPerUserChart').selectAll('*').remove();
      
      // Count projects directly from allUserProjects (using parseInt for type-safe comparison)
      const projectCount = allUserProjects.filter(up => parseInt(up.userId) === parseInt(userId)).length;
      
      if (projectCount === 0) {
        document.getElementById('projectsPerUserChart').innerHTML = 
          '<div style="text-align:center;padding:60px;color:#718096;"><i class="fas fa-folder-open" style="font-size:48px;color:#cbd5e0;margin-bottom:16px;display:block;"></i><p>This user has not enrolled in any projects yet</p></div>';
        return;
      }
      
      // Create simple metric display
      const container = document.getElementById('projectsPerUserChart');
      const width = container.offsetWidth;
      const height = 280;
      const margin = 20; // Add margin from edges
      
      const svg = d3.select('#projectsPerUserChart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
      
      // Create circular progress indicator
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = 70;
      
      // Background circle
      svg.append('circle')
        .attr('cx', centerX)
        .attr('cy', centerY)
        .attr('r', radius)
        .attr('fill', 'none')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', 12);
      
      // Progress circle
      const circumference = 2 * Math.PI * radius;
      const maxProjects = Math.max(...userProjectsData.map(u => u.projectCount), 10);
      const progress = (projectCount / maxProjects) * circumference;
      
      svg.append('circle')
        .attr('cx', centerX)
        .attr('cy', centerY)
        .attr('r', radius)
        .attr('fill', 'none')
        .attr('stroke', '#F0BB00')
        .attr('stroke-width', 12)
        .attr('stroke-linecap', 'round')
        .attr('stroke-dasharray', `${circumference} ${circumference}`)
        .attr('stroke-dashoffset', circumference)
        .attr('transform', `rotate(-90 ${centerX} ${centerY})`)
        .transition()
        .duration(1000)
        .attr('stroke-dashoffset', circumference - progress);
      
      // Center text - Number
      svg.append('text')
        .attr('x', centerX)
        .attr('y', centerY - 10)
        .attr('text-anchor', 'middle')
        .attr('dominant-baseline', 'middle')
        .style('font-size', '48px')
        .style('font-weight', '700')
        .style('fill', '#1a202c')
        .text('0')
        .transition()
        .duration(1000)
        .tween('text', function() {
          const interpolator = d3.interpolateNumber(0, projectCount);
          return function(t) {
            d3.select(this).text(Math.round(interpolator(t)));
          };
        });
      
      // Center text - Label
      svg.append('text')
        .attr('x', centerX)
        .attr('y', centerY + 25)
        .attr('text-anchor', 'middle')
        .style('font-size', '14px')
        .style('fill', '#718096')
        .text('Projects Enrolled');
      
      // Add comparison text
      const avgProjects = userProjectsData.length > 0 
        ? (userProjectsData.reduce((sum, u) => sum + u.projectCount, 0) / userProjectsData.length).toFixed(1)
        : 0;
      
      svg.append('text')
        .attr('x', centerX)
        .attr('y', height - 40)
        .attr('text-anchor', 'middle')
        .style('font-size', '13px')
        .style('fill', '#4a5568')
        .text(`Platform average: ${avgProjects} projects per user`);
      
      // Status badge
      const status = projectCount > avgProjects ? 'Above Average' : projectCount == avgProjects ? 'Average' : 'Below Average';
      const statusColor = projectCount > avgProjects ? '#48bb78' : projectCount == avgProjects ? '#F0BB00' : '#718096';
      
      svg.append('rect')
        .attr('x', centerX - 60)
        .attr('y', height - 20)
        .attr('width', 120)
        .attr('height', 24)
        .attr('rx', 12)
        .attr('fill', statusColor)
        .attr('opacity', 0.2);
      
      svg.append('text')
        .attr('x', centerX)
        .attr('y', height - 8)
        .attr('text-anchor', 'middle')
        .style('font-size', '11px')
        .style('font-weight', '600')
        .style('fill', statusColor)
        .text(status);
    }

    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderUserList(currentPage);
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(allUsers.length / USERS_PER_PAGE);
      if (currentPage < totalPages) {
        currentPage++;
        renderUserList(currentPage);
      }
    });

    // Initial render
    renderUserList(1);

    // D3.js Chart 1: User Registrations Last 7 Days
    function renderRegistrationsChart() {
      const last7Days = [];
      const today = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        const count = allUsers.filter(u => {
          if (!u.createdAt) return false;
          const userDate = new Date(u.createdAt).toISOString().split('T')[0];
          return userDate === dateStr;
        }).length;
        
        last7Days.push({
          date: dateStr,
          count: count,
          label: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
        });
      }

      const margin = { top: 20, right: 30, bottom: 60, left: 50 };
      const container = document.getElementById('registrationsChart');
      const width = container.offsetWidth - margin.left - margin.right;
      const height = 300 - margin.top - margin.bottom;

      const svg = d3.select('#registrationsChart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(last7Days.map(d => d.label))
        .range([0, width])
        .padding(0.3);

      const y = d3.scaleLinear()
        .domain([0, d3.max(last7Days, d => d.count) + 2])
        .range([height, 0]);

      // Grid lines
      svg.append('g')
        .attr('class', 'grid')
        .attr('opacity', 0.1)
        .call(d3.axisLeft(y).tickSize(-width).tickFormat(''));

      // Bars
      svg.selectAll('.bar')
        .data(last7Days)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.label))
        .attr('width', x.bandwidth())
        .attr('y', height)
        .attr('height', 0)
        .attr('fill', '#F0BB00')
        .attr('rx', 4)
        .transition()
        .duration(800)
        .attr('y', d => y(d.count))
        .attr('height', d => height - y(d.count));

      // Add value labels on bars
      svg.selectAll('.label')
        .data(last7Days)
        .enter()
        .append('text')
        .attr('class', 'label')
        .attr('x', d => x(d.label) + x.bandwidth() / 2)
        .attr('y', d => y(d.count) - 5)
        .attr('text-anchor', 'middle')
        .attr('fill', '#1a202c')
        .attr('font-size', '12px')
        .attr('font-weight', '600')
        .text(d => d.count);

      // X axis
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'rotate(-45)')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em');

      // Y axis
      svg.append('g')
        .call(d3.axisLeft(y).ticks(5));
    }

    // D3.js Chart 2: Role Distribution (Donut Chart)
    function renderRoleDistributionChart() {
      const roleCounts = {};
      allUsers.forEach(user => {
        const role = user.role || 'volunteer';
        roleCounts[role] = (roleCounts[role] || 0) + 1;
      });

      const data = Object.entries(roleCounts).map(([role, count]) => ({
        role: role,
        count: count
      }));

      const width = document.getElementById('roleDistributionChart').offsetWidth;
      const isMobile = width < 480;
      const isTablet = width >= 480 && width < 768;
      const height = isMobile ? 250 : 300;
      const svgHeight = isMobile ? 180 : height;
      const radius = isMobile ? Math.min(width, svgHeight) / 2 - 20 : Math.min(width, height) / 2 - 40;

      const svg = d3.select('#roleDistributionChart')
        .append('svg')
        .attr('width', width)
        .attr('height', svgHeight)
        .append('g')
        .attr('transform', `translate(${width / 2},${svgHeight / 2})`);

      const color = d3.scaleOrdinal()
        .domain(data.map(d => d.role))
        .range(['#feb2b2', '#bee3f8', '#c6f6d5', '#fbd38d']);

      const pie = d3.pie()
        .value(d => d.count)
        .sort(null);

      const arc = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius);

      const arcHover = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius * 1.05);

      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip');

      const arcs = svg.selectAll('.arc')
        .data(pie(data))
        .enter()
        .append('g')
        .attr('class', 'arc');

      arcs.append('path')
        .attr('d', arc)
        .attr('fill', d => color(d.data.role))
        .attr('stroke', '#fff')
        .attr('stroke-width', 3)
        .on('mouseover', function(event, d) {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('d', arcHover);
          
          tooltip
            .style('opacity', 1)
            .html(`<strong>${d.data.role}</strong><br>${d.data.count} users (${((d.data.count / allUsers.length) * 100).toFixed(1)}%)`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('d', arc);
          
          tooltip.style('opacity', 0);
        })
        .transition()
        .duration(800)
        .attrTween('d', function(d) {
          const interpolate = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
          return function(t) {
            return arc(interpolate(t));
          };
        });

      // Center text
      svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '-0.5em')
        .style('font-size', '32px')
        .style('font-weight', '700')
        .style('fill', '#1a202c')
        .text(allUsers.length);

      svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '1.2em')
        .style('font-size', '14px')
        .style('fill', '#718096')
        .text('Total Users');

      // Legend - Responsive
      if (isMobile) {
        // En móvil: leyenda horizontal debajo del donut
        const legendContainer = d3.select('#roleDistributionChart')
          .append('div')
          .style('display', 'flex')
          .style('flex-wrap', 'wrap')
          .style('justify-content', 'center')
          .style('gap', '6px')
          .style('margin-top', '8px')
          .style('padding', '0 8px');

        data.forEach(d => {
          const item = legendContainer.append('div')
            .style('display', 'flex')
            .style('align-items', 'center')
            .style('gap', '4px');

          item.append('div')
            .style('width', '12px')
            .style('height', '12px')
            .style('border-radius', '2px')
            .style('background', color(d.role))
            .style('flex-shrink', '0');

          item.append('span')
            .style('font-size', '11px')
            .style('color', '#4a5568')
            .text(`${d.role} (${d.count})`);
        });
      } else if (isTablet) {
        // En tablet: leyenda más compacta a la derecha
        const legend = svg.selectAll('.legend')
          .data(data)
          .enter()
          .append('g')
          .attr('class', 'legend')
          .attr('transform', (d, i) => `translate(${radius + 15},${-30 + i * 22})`);

        legend.append('rect')
          .attr('width', 14)
          .attr('height', 14)
          .attr('rx', 2)
          .attr('fill', d => color(d.role));

        legend.append('text')
          .attr('x', 18)
          .attr('y', 7)
          .attr('dy', '.35em')
          .style('font-size', '11px')
          .style('fill', '#4a5568')
          .text(d => `${d.role} (${d.count})`);
      } else {
        // Desktop: leyenda normal
        const legend = svg.selectAll('.legend')
          .data(data)
          .enter()
          .append('g')
          .attr('class', 'legend')
          .attr('transform', (d, i) => `translate(${radius + 20},${-40 + i * 25})`);

        legend.append('rect')
          .attr('width', 18)
          .attr('height', 18)
          .attr('rx', 3)
          .attr('fill', d => color(d.role));

        legend.append('text')
          .attr('x', 24)
          .attr('y', 9)
          .attr('dy', '.35em')
          .style('font-size', '13px')
          .style('fill', '#4a5568')
          .text(d => `${d.role} (${d.count})`);
      }
    }

    // D3.js Chart 4: User Activity Trend (Area Chart)
    function renderUserActivityChart() {
      // Generate daily data for last 7 days
      const days = [];
      const now = new Date();
      
      // Create array for last 7 days
      for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0); // Start of day
        
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        
        // Count enrollments created on this specific day
        const count = allUserProjects.filter(up => {
          if (!up.createdAt) return false;
          const createdDate = new Date(up.createdAt);
          createdDate.setHours(0, 0, 0, 0); // Normalize to start of day
          return createdDate.getTime() === date.getTime();
        }).length;
        
        days.push({
          month: dayName,
          count: count,
          date: date
        });
      }
      
      // Calculate accumulated counts (show growth trend)
      let accumulated = 0;
      days.forEach(d => {
        accumulated += d.count;
        d.accumulated = accumulated;
      });

      const container = document.getElementById('userActivityChart');
      const width = container.offsetWidth;
      const height = 280;
      const margin = { top: 20, right: 30, bottom: 60, left: 50 };

      const svg = d3.select('#userActivityChart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      const x = d3.scalePoint()
        .domain(days.map(d => d.month))
        .range([margin.left, width - margin.right])
        .padding(0.5);

      const y = d3.scaleLinear()
        .domain([0, d3.max(days, d => d.accumulated) * 1.1])
        .nice()
        .range([height - margin.bottom, margin.top]);

      // Area generator
      const area = d3.area()
        .x(d => x(d.month))
        .y0(height - margin.bottom)
        .y1(d => y(d.accumulated))
        .curve(d3.curveMonotoneX);

      // Line generator
      const line = d3.line()
        .x(d => x(d.month))
        .y(d => y(d.accumulated))
        .curve(d3.curveMonotoneX);

      // Gradient for area fill
      const gradient = svg.append('defs')
        .append('linearGradient')
        .attr('id', 'areaGradient')
        .attr('x1', '0%')
        .attr('y1', '0%')
        .attr('x2', '0%')
        .attr('y2', '100%');

      gradient.append('stop')
        .attr('offset', '0%')
        .attr('stop-color', '#F0BB00')
        .attr('stop-opacity', 0.6);

      gradient.append('stop')
        .attr('offset', '100%')
        .attr('stop-color', '#F0BB00')
        .attr('stop-opacity', 0.1);

      // Draw area
      svg.append('path')
        .datum(days)
        .attr('fill', 'url(#areaGradient)')
        .attr('d', area)
        .style('opacity', 0)
        .transition()
        .duration(1000)
        .style('opacity', 1);

      // Draw line
      svg.append('path')
        .datum(days)
        .attr('fill', 'none')
        .attr('stroke', '#F0BB00')
        .attr('stroke-width', 3)
        .attr('d', line)
        .attr('stroke-dasharray', function() {
          const length = this.getTotalLength();
          return `${length} ${length}`;
        })
        .attr('stroke-dashoffset', function() {
          return this.getTotalLength();
        })
        .transition()
        .duration(1500)
        .attr('stroke-dashoffset', 0);

      // Add points
      const tooltip = d3.select('body').append('div')
        .attr('class', 'tooltip');

      svg.selectAll('.dot')
        .data(days)
        .enter()
        .append('circle')
        .attr('class', 'dot')
        .attr('cx', d => x(d.month))
        .attr('cy', d => y(d.accumulated))
        .attr('r', 0)
        .attr('fill', '#F0BB00')
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .on('mouseover', function(event, d) {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('r', 8);
          
          tooltip
            .style('opacity', 1)
            .html(`<strong>${d.month}</strong><br>Active Enrollments: ${d.accumulated}<br>New: +${d.count}`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function() {
          d3.select(this)
            .transition()
            .duration(200)
            .attr('r', 5);
          
          tooltip.style('opacity', 0);
        })
        .transition()
        .delay((d, i) => i * 100 + 1000)
        .duration(400)
        .attr('r', 5);

      // X axis
      svg.append('g')
        .attr('transform', `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', 'rotate(-45)');

      // Y axis
      svg.append('g')
        .attr('transform', `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(5));

      // Y axis label
      svg.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('y', margin.left - 35)
        .attr('x', -(height / 2))
        .attr('text-anchor', 'middle')
        .style('font-size', '12px')
        .style('fill', '#718096')
        .text('Total Active Users');
    }

    // Render charts on load
    if (typeof d3 !== 'undefined') {
      renderRegistrationsChart();
      renderRoleDistributionChart();
      renderUserActivityChart();
      // User projects chart renders on user click
    }
  </script>
  <% } %>

  <% if (currentSection === 'categories') { %>
    <%- include('categories-dashboard', { categories: categories, projects: projects, allUserProjects: allUserProjects }) %>
  <% } %>

  <% if (currentSection === 'reviews') { %>
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-star" style="color: #F0BB00;"></i>
      Reviews
    </h2>
    <p style="color: #4a5568; margin-bottom: 20px;">Total reviews: <%= reviews ? reviews.length : 0 %></p>
    
    <% if (reviews && reviews.length) { %>
      <ul class="item-list">
        <% reviews.forEach(function(r){ %>
          <li class="item-list-item">
            <div class="item-description"><%= r.content || ('Review #' + r.id) %></div>
            <% if (r.date) { %>
              <div class="item-meta"><%= new Date(r.date).toLocaleDateString() %></div>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <div class="empty-state">
        <i class="fas fa-star"></i>
        <p>No reviews available</p>
      </div>
    <% } %>
  </div>
  <% } %>

  <% if (currentSection === 'contacts') { %>
  <!-- D3.js Library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <div class="section-card">
    <h2 class="section-title">
      <i class="fas fa-exclamation-triangle" style="color: #F0BB00;"></i>
      Incidents Dashboard
    </h2>
    <p style="color: #4a5568; margin-bottom: 30px; font-size: 15px;">
      Analytics and visualizations for incident management
    </p>

    <div class="incidents-stats">
      <div class="incident-stat-card">
        <div class="incident-stat-icon" style="background: linear-gradient(135deg, #F0BB00, #B39519);">
          <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="incident-stat-content">
          <div class="incident-stat-number"><%= contacts ? contacts.length : 0 %></div>
          <div class="incident-stat-label">Total Incidents</div>
        </div>
      </div>
      
      <div class="incident-stat-card">
        <div class="incident-stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="incident-stat-content">
          <div class="incident-stat-number">
            <%= contacts ? contacts.filter(c => c.read === 1 || c.read === true || c.read === '1').length : 0 %>
          </div>
          <div class="incident-stat-label">Closed</div>
        </div>
      </div>
      
      <div class="incident-stat-card">
        <div class="incident-stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <i class="fas fa-clock"></i>
        </div>
        <div class="incident-stat-content">
          <div class="incident-stat-number">
            <%= contacts ? contacts.filter(c => c.read === 0 || c.read === false || c.read === '0').length : 0 %>
          </div>
          <div class="incident-stat-label">Pending</div>
        </div>
      </div>
    </div>

    <div class="incidents-grid">
      <!-- Chart 1: Incidents Created -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-plus-circle" style="color: #F0BB00;"></i>
            Incidents Created
          </h3>
          <div class="time-filter">
            <button class="filter-btn active" data-chart="created" data-period="30">30 Days</button>
            <button class="filter-btn" data-chart="created" data-period="7">7 Days</button>
            <button class="filter-btn" data-chart="created" data-period="1">Today</button>
          </div>
        </div>
        <div id="incidentsCreatedChart"></div>
      </div>

      <!-- Chart 2: Incidents Closed -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-check-circle" style="color: #10b981;"></i>
            Incidents Closed
          </h3>
          <div class="time-filter">
            <button class="filter-btn active" data-chart="closed" data-period="30">30 Days</button>
            <button class="filter-btn" data-chart="closed" data-period="7">7 Days</button>
            <button class="filter-btn" data-chart="closed" data-period="1">Today</button>
          </div>
        </div>
        <div id="incidentsClosedChart"></div>
      </div>

      <!-- Chart 3: Status Distribution -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-chart-pie" style="color: #F0BB00;"></i>
            Status Distribution
          </h3>
        </div>
        <div id="statusDistributionChart"></div>
      </div>

      <!-- Chart 4: Response Time Average -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-clock" style="color: #F0BB00;"></i>
            Average Response Time
          </h3>
        </div>
        <div id="avgResponseTimeChart"></div>
      </div>
    </div>
  </div>

  <style>
    .incidents-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .incident-stat-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .incident-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .incident-stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .incident-stat-content {
      flex: 1;
    }
    
    .incident-stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #1a202c;
      line-height: 1;
      margin-bottom: 5px;
    }
    
    .incident-stat-label {
      font-size: 13px;
      color: #718096;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .incidents-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .chart-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #F0BB00;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-filter {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: #FEF3C7;
      border-color: #F0BB00;
      color: #92400e;
    }

    .filter-btn.active {
      background: #F0BB00;
      border-color: #F0BB00;
      color: white;
    }

    #incidentsCreatedChart,
    #incidentsClosedChart,
    #statusDistributionChart,
    #avgResponseTimeChart {
      width: 100%;
      height: 300px;
    }

    @media (max-width: 1400px) {
      .incidents-grid {
        gap: 20px;
      }
    }

    @media (max-width: 1024px) {
      .incidents-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .chart-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .time-filter {
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .incidents-stats {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .chart-card {
        padding: 16px;
      }

      .chart-title {
        font-size: 16px;
      }

      .filter-btn {
        padding: 5px 10px;
        font-size: 11px;
      }

      #incidentsCreatedChart,
      #incidentsClosedChart,
      #statusDistributionChart,
      #avgResponseTimeChart {
        height: 250px;
      }
    }

    @media (max-width: 480px) {
      .incidents-stats {
        gap: 12px;
      }

      .incident-stat-card {
        padding: 15px;
      }

      .incident-stat-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .incident-stat-number {
        font-size: 24px;
      }

      .time-filter {
        flex-wrap: wrap;
      }
    }
  </style>

  <script>
    // Get contacts data
    const contactsData = <%- JSON.stringify(contacts || []) %>;
    console.log('Total contacts:', contactsData.length);

    // Helper function to get date range
    function getDateRange(days) {
      const dates = [];
      const today = new Date();
      
      if (days === 1) {
        // For "today", just return today
        dates.push(today.toISOString().split('T')[0]);
      } else {
        // For multiple days, get the range
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          dates.push(date.toISOString().split('T')[0]);
        }
      }
      
      return dates;
    }

    // Helper function to format date for display
    function formatDateForDisplay(dateStr, days) {
      const date = new Date(dateStr);
      if (days === 1) {
        return 'Today';
      } else if (days === 7) {
        const options = { weekday: 'short', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      } else {
        const options = { month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }
    }

    // Chart 1: Incidents Created Over Time
    function renderIncidentsCreatedChart(days = 30) {
      const chartElement = document.getElementById('incidentsCreatedChart');
      if (!chartElement) return;

      // Clear previous chart
      d3.select('#incidentsCreatedChart').selectAll('*').remove();

      const dateRange = getDateRange(days);
      const data = dateRange.map(date => {
        const count = contactsData.filter(contact => {
          if (!contact.createdAt && !contact.created_at) return false;
          const contactDate = new Date(contact.createdAt || contact.created_at).toISOString().split('T')[0];
          return contactDate === date;
        }).length;
        return { date, count };
      });

      console.log('Incidents created data:', data);

      // Set up dimensions
      const margin = { top: 20, right: 20, bottom: 40, left: 40 };
      const width = chartElement.offsetWidth - margin.left - margin.right;
      const height = 300 - margin.top - margin.bottom;

      // Create SVG
      const svg = d3.select('#incidentsCreatedChart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      // Create scales
      const x = d3.scaleBand()
        .domain(data.map(d => d.date))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.count) || 1])
        .nice()
        .range([height, 0]);

      // Add bars
      svg.selectAll('.bar')
        .data(data)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.date))
        .attr('y', d => y(d.count))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.count))
        .attr('fill', '#F0BB00')
        .attr('rx', 4);

      // Add X axis
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d => formatDateForDisplay(d, days)))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', 'rotate(-45)');

      // Add Y axis
      svg.append('g')
        .call(d3.axisLeft(y).ticks(5));

      // Add value labels on bars
      svg.selectAll('.label')
        .data(data)
        .enter()
        .append('text')
        .attr('class', 'label')
        .attr('x', d => x(d.date) + x.bandwidth() / 2)
        .attr('y', d => y(d.count) - 5)
        .attr('text-anchor', 'middle')
        .style('font-size', '12px')
        .style('font-weight', '600')
        .style('fill', '#1a202c')
        .text(d => d.count);
    }

    // Chart 2: Incidents Closed Over Time
    function renderIncidentsClosedChart(days = 30) {
      const chartElement = document.getElementById('incidentsClosedChart');
      if (!chartElement) return;

      // Clear previous chart
      d3.select('#incidentsClosedChart').selectAll('*').remove();

      const dateRange = getDateRange(days);
      const data = dateRange.map(date => {
        const count = contactsData.filter(contact => {
          if (!contact.updatedAt && !contact.updated_at) return false;
          if (contact.read !== 1 && contact.read !== true && contact.read !== '1') return false;
          const contactDate = new Date(contact.updatedAt || contact.updated_at).toISOString().split('T')[0];
          return contactDate === date;
        }).length;
        return { date, count };
      });

      console.log('Incidents closed data:', data);

      // Set up dimensions
      const margin = { top: 20, right: 20, bottom: 40, left: 40 };
      const width = chartElement.offsetWidth - margin.left - margin.right;
      const height = 300 - margin.top - margin.bottom;

      // Create SVG
      const svg = d3.select('#incidentsClosedChart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      // Create scales
      const x = d3.scaleBand()
        .domain(data.map(d => d.date))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.count) || 1])
        .nice()
        .range([height, 0]);

      // Add bars
      svg.selectAll('.bar')
        .data(data)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.date))
        .attr('y', d => y(d.count))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.count))
        .attr('fill', '#10b981')
        .attr('rx', 4);

      // Add X axis
      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d => formatDateForDisplay(d, days)))
        .selectAll('text')
        .style('text-anchor', 'end')
        .attr('dx', '-.8em')
        .attr('dy', '.15em')
        .attr('transform', 'rotate(-45)');

      // Add Y axis
      svg.append('g')
        .call(d3.axisLeft(y).ticks(5));

      // Add value labels on bars
      svg.selectAll('.label')
        .data(data)
        .enter()
        .append('text')
        .attr('class', 'label')
        .attr('x', d => x(d.date) + x.bandwidth() / 2)
        .attr('y', d => y(d.count) - 5)
        .attr('text-anchor', 'middle')
        .style('font-size', '12px')
        .style('font-weight', '600')
        .style('fill', '#1a202c')
        .text(d => d.count);
    }

    // Chart 3: Status Distribution (Donut Chart)
    function renderStatusDistributionChart() {
      const chartElement = document.getElementById('statusDistributionChart');
      if (!chartElement) return;

      // Clear previous chart
      d3.select('#statusDistributionChart').selectAll('*').remove();

      // Filter and count data
      const openCount = contactsData.filter(c => c.read === 0 || c.read === false || c.read === '0').length;
      const closedCount = contactsData.filter(c => c.read === 1 || c.read === true || c.read === '1').length;
      
      const data = [
        { status: 'Open', count: openCount, color: '#f59e0b' },
        { status: 'Closed', count: closedCount, color: '#10b981' }
      ].filter(d => d.count > 0);

      console.log('Status Distribution - Total contacts:', contactsData.length);
      console.log('Open/Closed counts:', { openCount, closedCount });

      if (data.length === 0) {
        d3.select('#statusDistributionChart')
          .append('div')
          .style('text-align', 'center')
          .style('padding', '40px')
          .style('color', '#718096')
          .text('No data available');
        return;
      }

      // Set up dimensions
      const width = chartElement.offsetWidth;
      const height = 300;
      const margin = 40;
      const radius = Math.min(width, height) / 2 - margin;

      // Create SVG
      const svg = d3.select('#statusDistributionChart')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .append('g')
        .attr('transform', `translate(${width / 2},${height / 2 - 20})`);

      // Create donut
      const pie = d3.pie().value(d => d.count);
      const arc = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius);

      // Add slices
      const slices = svg.selectAll('path')
        .data(pie(data))
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', d => d.data.color)
        .attr('stroke', 'white')
        .attr('stroke-width', 2);

      // Add center text
      const total = data.reduce((sum, d) => sum + d.count, 0);
      svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '-0.5em')
        .style('font-size', '32px')
        .style('font-weight', '700')
        .style('fill', '#1a202c')
        .text(total);

      svg.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '1.2em')
        .style('font-size', '14px')
        .style('fill', '#718096')
        .text('Total Incidents');

      // Add legend below
      const legend = d3.select('#statusDistributionChart')
        .append('div')
        .style('display', 'flex')
        .style('justify-content', 'center')
        .style('gap', '24px')
        .style('margin-top', '20px');

      data.forEach(d => {
        const item = legend.append('div')
          .style('display', 'flex')
          .style('align-items', 'center')
          .style('gap', '8px');

        item.append('div')
          .style('width', '12px')
          .style('height', '12px')
          .style('border-radius', '50%')
          .style('background-color', d.color);

        item.append('span')
          .style('font-size', '14px')
          .style('color', '#4a5568')
          .text(`${d.status}: ${d.count}`);
      });
    }

    // Chart 4: Average Response Time (Gauge)
    function renderAvgResponseTimeChart() {
      const chartElement = document.getElementById('avgResponseTimeChart');
      if (!chartElement) return;

      // Clear previous chart
      d3.select('#avgResponseTimeChart').selectAll('*').remove();

      // Calculate response time statistics
      const closedIncidents = contactsData.filter(c => {
        const isClosed = c.read === 1 || c.read === true || c.read === '1';
        const hasCreated = c.createdAt || c.created_at;
        const hasUpdated = c.updatedAt || c.updated_at;
        return isClosed && hasCreated && hasUpdated;
      });

      let avgResponseTime = 0;
      let minResponseTime = 0;
      let maxResponseTime = 0;
      let closedCount = 0;
      let pendingCount = contactsData.length - closedIncidents.length;
      let fastCount = 0; // < 24h
      let slowCount = 0; // >= 48h

      if (closedIncidents.length > 0) {
        const responseTimes = closedIncidents.map(c => {
          const created = new Date(c.createdAt || c.created_at);
          const closed = new Date(c.updatedAt || c.updated_at);
          return (closed - created) / (1000 * 60 * 60); // hours
        });

        avgResponseTime = responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length;
        minResponseTime = Math.min(...responseTimes);
        maxResponseTime = Math.max(...responseTimes);
        closedCount = closedIncidents.length;
        fastCount = responseTimes.filter(t => t < 24).length;
        slowCount = responseTimes.filter(t => t >= 48).length;
      }

      // Set up dimensions
      const width = chartElement.offsetWidth;
      const height = 300;
      const gaugeWidth = Math.min(width * 0.5, 250);
      const gaugeRadius = gaugeWidth / 2 - 20;

      // Create SVG
      const svg = d3.select('#avgResponseTimeChart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // Left side: Gauge
      const gaugeG = svg.append('g')
        .attr('transform', `translate(${gaugeWidth / 2 + 20},${height / 2 + 20})`);

      // Create gauge arc (semicircle pointing up: from -PI/2 to PI/2)
      const arc = d3.arc()
        .innerRadius(gaugeRadius * 0.7)
        .outerRadius(gaugeRadius)
        .startAngle(-Math.PI / 2)
        .endAngle(Math.PI / 2);

      // Background arc
      gaugeG.append('path')
        .attr('d', arc)
        .attr('fill', '#e2e8f0');

      // Color segments for reference
      const segments = [
        { start: 0, end: 24, color: '#10b981', opacity: 0.3 },
        { start: 24, end: 48, color: '#f59e0b', opacity: 0.3 },
        { start: 48, end: 72, color: '#ef4444', opacity: 0.3 }
      ];

      segments.forEach(seg => {
        const segmentArc = d3.arc()
          .innerRadius(gaugeRadius * 0.7)
          .outerRadius(gaugeRadius)
          .startAngle(-Math.PI / 2 + Math.PI * (seg.start / 72))
          .endAngle(-Math.PI / 2 + Math.PI * (seg.end / 72));

        gaugeG.append('path')
          .attr('d', segmentArc)
          .attr('fill', seg.color)
          .attr('opacity', seg.opacity);
      });

      // Value arc
      const maxHours = 72;
      const percentage = Math.min(avgResponseTime / maxHours, 1);
      const color = avgResponseTime < 24 ? '#10b981' : avgResponseTime < 48 ? '#f59e0b' : '#ef4444';

      const valueArc = d3.arc()
        .innerRadius(gaugeRadius * 0.7)
        .outerRadius(gaugeRadius)
        .startAngle(-Math.PI / 2)
        .endAngle(-Math.PI / 2 + Math.PI * percentage);

      gaugeG.append('path')
        .attr('d', valueArc)
        .attr('fill', color);

      // Center text
      gaugeG.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '-0.3em')
        .style('font-size', '32px')
        .style('font-weight', '700')
        .style('fill', '#1a202c')
        .text(avgResponseTime.toFixed(1));

      gaugeG.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '1.2em')
        .style('font-size', '13px')
        .style('fill', '#718096')
        .style('font-weight', '600')
        .text('HOURS');



      // Right side: Statistics grid
      const statsX = gaugeWidth + 40;
      const statsY = 40;
      const statBoxWidth = (width - statsX - 40) / 2;
      const statBoxHeight = 70;
      const gap = 15;

      const stats = [
        { 
          label: 'Fastest', 
          value: minResponseTime.toFixed(1), 
          unit: 'h',
          icon: '⚡',
          color: '#10b981',
          row: 0,
          col: 0
        },
        { 
          label: 'Slowest', 
          value: maxResponseTime.toFixed(1), 
          unit: 'h',
          icon: '🐌',
          color: '#ef4444',
          row: 0,
          col: 1
        },
        { 
          label: 'Fast (<24h)', 
          value: fastCount, 
          unit: '',
          icon: '✓',
          color: '#10b981',
          row: 1,
          col: 0
        },
        { 
          label: 'Slow (≥48h)', 
          value: slowCount, 
          unit: '',
          icon: '⚠',
          color: '#f59e0b',
          row: 1,
          col: 1
        },
        { 
          label: 'Resolved', 
          value: closedCount, 
          unit: '',
          icon: '✓',
          color: '#10b981',
          row: 2,
          col: 0
        },
        { 
          label: 'Pending', 
          value: pendingCount, 
          unit: '',
          icon: '⏱',
          color: '#F0BB00',
          row: 2,
          col: 1
        }
      ];

      stats.forEach(stat => {
        const x = statsX + stat.col * (statBoxWidth + gap);
        const y = statsY + stat.row * (statBoxHeight + gap);

        const statG = svg.append('g')
          .attr('transform', `translate(${x},${y})`);

        // Background box
        statG.append('rect')
          .attr('width', statBoxWidth)
          .attr('height', statBoxHeight)
          .attr('rx', 8)
          .attr('fill', '#f7fafc')
          .attr('stroke', '#e2e8f0')
          .attr('stroke-width', 1);

        // Icon circle
        statG.append('circle')
          .attr('cx', 25)
          .attr('cy', statBoxHeight / 2)
          .attr('r', 16)
          .attr('fill', stat.color)
          .attr('opacity', 0.15);

        // Icon
        statG.append('text')
          .attr('x', 25)
          .attr('y', statBoxHeight / 2)
          .attr('text-anchor', 'middle')
          .attr('dy', '0.3em')
          .style('font-size', '16px')
          .text(stat.icon);

        // Value
        statG.append('text')
          .attr('x', 50)
          .attr('y', statBoxHeight / 2 - 8)
          .style('font-size', '22px')
          .style('font-weight', '700')
          .style('fill', '#1a202c')
          .text(stat.value + stat.unit);

        // Label
        statG.append('text')
          .attr('x', 50)
          .attr('y', statBoxHeight / 2 + 12)
          .style('font-size', '11px')
          .style('fill', '#718096')
          .style('font-weight', '600')
          .text(stat.label.toUpperCase());
      });

      // Performance indicator badge
      let performance = 'EXCELLENT';
      let perfColor = '#10b981';
      if (avgResponseTime >= 48) {
        performance = 'NEEDS IMPROVEMENT';
        perfColor = '#ef4444';
      } else if (avgResponseTime >= 24) {
        performance = 'GOOD';
        perfColor = '#f59e0b';
      }

      const badgeG = svg.append('g')
        .attr('transform', `translate(${width / 2},${height - 25})`);

      const badgeWidth = 180;
      const badgeHeight = 30;

      badgeG.append('rect')
        .attr('x', -badgeWidth / 2)
        .attr('y', -badgeHeight / 2)
        .attr('width', badgeWidth)
        .attr('height', badgeHeight)
        .attr('rx', 15)
        .attr('fill', perfColor)
        .attr('opacity', 0.1)
        .attr('stroke', perfColor)
        .attr('stroke-width', 2);

      badgeG.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.3em')
        .style('font-size', '12px')
        .style('font-weight', '700')
        .style('fill', perfColor)
        .text(performance);
    }

    // Initial render with 30 days
    renderIncidentsCreatedChart(30);
    renderIncidentsClosedChart(30);
    renderStatusDistributionChart();
    renderAvgResponseTimeChart();

    // Filter button handlers
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const chart = this.dataset.chart;
        const period = parseInt(this.dataset.period);
        
        // Update active state
        this.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Re-render chart
        if (chart === 'created') {
          renderIncidentsCreatedChart(period);
        } else if (chart === 'closed') {
          renderIncidentsClosedChart(period);
        }
      });
    });

    // Responsive resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const activeCreatedBtn = document.querySelector('.filter-btn[data-chart="created"].active');
        const activeClosedBtn = document.querySelector('.filter-btn[data-chart="closed"].active');
        
        const createdPeriod = activeCreatedBtn ? parseInt(activeCreatedBtn.dataset.period) : 30;
        const closedPeriod = activeClosedBtn ? parseInt(activeClosedBtn.dataset.period) : 30;
        
        renderIncidentsCreatedChart(createdPeriod);
        renderIncidentsClosedChart(closedPeriod);
        renderStatusDistributionChart();
        renderAvgResponseTimeChart();
      }, 250);
    });
  </script>
  <% } %>

</body>
</html>

      </div>
    </div>
  </body>
</html>